<!DOCTYPE html>
<html lang="en">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.1/css/all.css" crossorigin="anonymous">
  <head>
    <meta charset="UTF-8" />
    <title>Chatbot</title>
  </head>
  <body>
    <div class="container">
      <div class="chatbox">
        <div class="chatbox__support">
          <div class="chatbox__header">
            <div class="chatbox__image--header">
              <img
                src="https://img.icons8.com/color/48/000000/circled-user-female-skin-type-5--v1.png"
                alt="image"
              />
            </div>
            <div class="chatbox__content--header">
              <h4 class="chatbox__heading--header">Chat support</h4>
              <p class="chatbox__description--header">
                Hi. My name is Sam. How can I help you?
              </p>
            </div>
          </div>
          <div class="chatbox__messages">
            <div></div>
          </div>
          <div class="chatbox__footer">
            <button class="chatbox__send--footer voice__button"><i class="fa fa-microphone"></i></button>
            <input type="text" placeholder="Write a message..." />
            <button class="chatbox__send--footer send__button">Send</button>
          </div>
        </div>
        <div class="chatbox__button">
          <button>
            <img
              src="{{ url_for('static', filename='images/chatbox-icon.svg') }}"
            />
          </button>
        </div>
      </div>
    </div>

    <!-- <script>
        $SCRIPT_ROOT = {{ request.script_root|tojson }};
    </script> -->
    <script>
      class Chatbox {
        constructor() {
          this.args = {
            openButton: document.querySelector(".chatbox__button"),
            chatBox: document.querySelector(".chatbox__support"),
            sendButton: document.querySelector(".send__button"),
            voiceButton: document.querySelector('.voice__button'),
          };

          this.state = false;
          this.message = [];
        }
        display() {
          const { openButton, chatBox, sendButton, voiceButton } = this.args;

          openButton.addEventListener("click", () => this.toggleState(chatBox));

          sendButton.addEventListener("click", () =>
            this.onSendButton(chatBox)
          );
          voiceButton.addEventListener('click', () => this.onVoiceButton(chatBox))

          const node = chatBox.querySelector("input");
          node.addEventListener("keyup", ({ key }) => {
            if (key === "Enter") {
              this.onSendButton(chatBox);
            }
          });
        }
        toggleState(chatbox) {
          this.state = !this.state;
          if (this.state) {
            chatbox.classList.add('chatbox--active')
            fetch("http://chatbot-api-leqdt7akva-as.a.run.app/welcome", {
                method: 'POST',
                body: JSON.stringify(),
                mode: 'cors',
                headers: {
                    'Content-Type': 'application/json'
                },
            })
            .then(r => r.json())
            .then(r => {
                let msg = {name: "Sam", message: r};
                console.log(r)
                // this.text2speak(msg.message)
                console.log(msg.message);
                this.message.push(msg);
                this.updateChatText(chatbox)
            }).catch((error) => {
                console.log('Error: ', error);
                this.updateChatText(chatbox)
            });
        }
        else{
            chatbox.classList.remove('chatbox--active');
        }
        }
        onSendButton(chatbox) {
          var textField = chatbox.querySelector("input");
          let text1 = textField.value;
          if (text1 === "") {
            return;
          }
          let msg1 = { name: "User", message: text1 };
          this.message.push(msg1);
          fetch("http://chatbot-api-leqdt7akva-as.a.run.app/response", {
            method: "POST",
            body: JSON.stringify({ message: text1 }),
            mode: "cors",
            headers: {
              "Content-Type": "application/json",
            },
          })
            .then((r) => r.json())
            .then((r) => {
              let msg2 = { name: "Sam", message: r.res_text };
              this.message.push(msg2);
              this.updateChatText(chatbox);
              textField.value = "";
            })
            .catch((error) => {
              console.error("Error: ", error);
              this.updateChatText(chatbox);
              textField.value = "";
            });
        }
        onVoiceButton(chatbox){
        var grammar = '#JSGF V1.0;'
        var SpeechRecognition = SpeechRecognition || webkitSpeechRecognition;
        var SpeechGrammarList = SpeechGrammarList || webkitSpeechGrammarList;
        var recognition = new SpeechRecognition();
        var speechRecognitionList = new SpeechGrammarList();
        speechRecognitionList.addFromString(grammar, 1);
        recognition.grammars = speechRecognitionList;
        recognition.lang = 'vi-VN';
        recognition.interimResults = false;
        var content;
        if (!this.recordS){
            recognition.start();
            console.log("starting")
            recognition.onerror = function(event) {
                // message.textContent = 'Error occurred in recognition: ' + event.error;
                console.log(event.error)
            }

            recognition.onresult = function(event) {
                var lastResult = event.results.length - 1;
                content = event.results[lastResult][0].transcript;
                var chatmessage = chatbox.querySelector('.chatbox__messages');
                chatmessage.textField = content
                // content = content.json()
            }
            recognition.onspeechend = function() {
                recognition.stop();
                
            }
            this.recordS = true;
        }
        else {
            var chatmessage = chatbox.querySelector('.chatbox__messages');
            content = chatmessage.textField;
            console.log(content)
            let msg1 = {name: "User", message: content}
            this.message.push(msg1);
            this.updateChatText(chatbox)
            // 'http://127.0.0.1:5000/voice_predict
            fetch("http://chatbot-api-leqdt7akva-as.a.run.app/response", {
                method: 'POST',
                body: JSON.stringify({message: content}),
                mode: 'cors',
                headers: {
                    'Content-Type': 'application/json'
                },
            })
            .then(r => r.json())
            .then(r => {
                let msg3 = {name: "Sam", message: r.res_text};
                this.message.push(msg3);
                this.updateChatText(chatbox)
            }).catch((error) => {
                // console.error('Error: ', error);
                this.updateChatText(chatbox)
            });
            this.recordS = false;
        }
        };
        updateChatText(chatbox) {
          var html = "";
          this.message
            .slice()
            .reverse()
            .forEach(function (item) {
              if (item.name === "Sam") {
                html +=
                  '<div class="messages__item messages__item--visitor">' +
                  item.message +
                  "</div>";
              } else {
                html +=
                  '<div class="messages__item messages__item--operator">' +
                  item.message +
                  "</div>";
              }
            });
          const chatmessage = chatbox.querySelector(".chatbox__messages");
          chatmessage.innerHTML = html;
        }
      }

      const chatbox = new Chatbox();
      chatbox.display();
    </script>
  </body>
</html>
